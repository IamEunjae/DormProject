{% load static %}
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>기숙사 라운지 예약(30분 슬롯)</title>
  <link rel="stylesheet" href="{% static 'css/styles.css' %}">
  <style>
    .container{max-width:1100px;margin:0 auto;padding:1rem}
    .grid{border-collapse:collapse;width:100%}
    .grid th,.grid td{border:1px solid #ddd;padding:.65rem;text-align:center}
    .grid thead th{background:#f6f7fb}
    .cell-free{background:#e9f7ef}
    .cell-reserved{background:#fde2e2}
    .btn{padding:.4rem .8rem;border:1px solid #999;border-radius:6px;background:#fff;cursor:pointer}
    .btn.primary{background:#0d6efd;color:#fff;border-color:#0d6efd}
    .btn:disabled{background:#ccc;border-color:#ccc;color:#666;cursor:not-allowed}
    .names{width:100%;max-width:18rem;padding:.4rem;border:1px solid #ccc;border-radius:6px}
    .topbar{display:flex;gap:.75rem;align-items:center;flex-wrap:wrap}
    .muted{color:#666;font-size:.92rem}
    .notice{
      margin:.75rem 0 1rem;padding:.9rem 1rem;border:1px solid #e5e7eb;
      background:#fffbea;border-radius:8px;line-height:1.5
    }
    .notice ol{margin:.4rem 0 0 .9rem}
    .notice li{margin:.2rem 0}
    .visually-hidden{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
</head>
<body>
<div class="container">
  {% if user.is_authenticated %}
    <div class="topbar">
      <p>안녕하세요, <b>{{ user.name }}</b>님 ({{ user.student_number }})</p>
      <form method="post" action="{% url 'login:logout' %}" style="display:inline;">
        {% csrf_token %}
        <button type="submit" class="btn">로그아웃</button>
      </form>
    </div>
  {% endif %}

  <h1>기숙사 라운지 예약 (30분 슬롯)</h1>

  <!-- 라운지 이용 안내 -->
  <div class="notice">
    <b>라운지 이용 안내</b>
    <ol>
      <li>학습 용도만 이용(당일 예약)</li>
      <li>예약은 최대 30분입니다. (3학년 제외) 뒤에 예약자가 없을 경우 30분 단위로 추가 연장 가능</li>
      <li>선생님께 “라운지 신청했습니다” 연락하고 사용하기</li>
      <li>23:30 이후 이용 불가</li>
      <li>시간 미준수, 뒷정리(소등, 에어컨 off, 문개방) 미흡 및 예약 후 미사용 시 이용 제한</li>
      <li>신청 가능한 시간 외 이용 시 선생님께 허락 받고 사용하기</li>
    </ol>
  </div>

  <p class="muted">일요일: 22:00~23:30 (3칸) / 월~목: 21:30~23:30 (4칸) / 금·토: 예약 불가</p>

  <form method="get" style="margin:.75rem 0;display:flex;gap:.5rem;align-items:center;flex-wrap:wrap">
    <input type="date" name="date" value="{{ date|date:'Y-m-d' }}">
    <button class="btn" type="submit">날짜 이동</button>
  </form>

  {% if no_slots %}
    <p><b>해당 요일은 예약할 수 없습니다. (금/토)</b></p>
  {% else %}
  <table class="grid" aria-describedby="desc">
    <caption id="desc" class="visually-hidden">선택한 날짜의 30분 단위 라운지 예약 표</caption>
    <thead>
      <tr>
        <th>시간</th>
        {% for lg in lounges %}
          <th>
            {% if lg.number == 1 %}
              라운지 A
            {% elif lg.number == 2 %}
              라운지 G
            {% else %}
              라운지 {{ lg.number }}
            {% endif %}
          </th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for row in grid %}
        <tr>
          <td><b>{{ row.label }}</b></td>
          {% for cell in row.cells %}
            <td class="{% if cell.reserved %}cell-reserved{% else %}cell-free{% endif %}">
              {% if cell.reserved %}
                <div>{{ cell.by|default:"-" }}</div>
                <button class="btn" disabled>예약 불가</button>
              {% else %}
                <form method="post" action="{% url 'reservation:reserve_slot' cell.number cell.start_key %}" autocomplete="off">
                  {% csrf_token %}
                  <input name="names" class="names" placeholder="신청자 이름들(쉼표 구분)" {% if cell.disabled %}disabled{% endif %}>
                  <button type="submit" class="btn primary" {% if cell.disabled %}disabled{% endif %}>
                    {% if cell.disabled %}마감{% else %}예약{% endif %}
                  </button>
                </form>
              {% endif %}
            </td>
          {% endfor %}
        </tr>
      {% endfor %}
    </tbody>
  </table>
  {% endif %}
</div>
</body>
</html>
